{% extends 'base.html' %}
{% load static %}

{% block title %}Quản lý đơn hàng - Trà Sữa Online{% endblock %}

{% block content %}
<div class="container py-5">
    <div class="row">
        <div class="col-12">
            <h2 class="mb-4">
                <i class="fas fa-shopping-bag"></i> Quản lý đơn hàng
            </h2>
        </div>
    </div>
    
    <div class="row">
        <div class="col-12">
            <div class="admin-panel">
                <div class="row mb-3">
                    <div class="col-md-4">
                        <input type="text" class="form-control" id="search-orders" placeholder="Tìm kiếm theo tên, SĐT...">
                    </div>
                    <div class="col-md-3">
                        <select class="form-control" id="filter-status">
                            <option value="">Tất cả trạng thái</option>
                            <option value="pending">Chờ xử lý</option>
                            <option value="confirmed">Đã xác nhận</option>
                            <option value="preparing">Đang chuẩn bị</option>
                            <option value="ready">Sẵn sàng</option>
                            <option value="delivered">Đã giao</option>
                            <option value="cancelled">Đã hủy</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <select class="form-control" id="filter-payment">
                            <option value="">Tất cả phương thức</option>
                            <option value="cod">Thanh toán khi nhận hàng</option>
                            <option value="online">Thanh toán online</option>
                        </select>
                    </div>
                    <div class="col-md-2">
                        <button class="btn btn-primary w-100" onclick="loadOrders()">
                            <i class="fas fa-sync"></i> Làm mới
                        </button>
                    </div>
                </div>
                
                <div id="orders-container">
                    <div class="loading">
                        <div class="spinner-border" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <p>Đang tải đơn hàng...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    let allOrders = [];
    
    // Load data when page loads
    document.addEventListener('DOMContentLoaded', function() {
        loadOrders();
        
        // Add event listeners for filters
        document.getElementById('search-orders').addEventListener('input', filterOrders);
        document.getElementById('filter-status').addEventListener('change', filterOrders);
        document.getElementById('filter-payment').addEventListener('change', filterOrders);
    });
    
    // Load orders
    async function loadOrders() {
        try {
            const response = await fetch('/api/orders/orders/');
            allOrders = await response.json();
            renderOrders(allOrders);
        } catch (error) {
            console.error('Error loading orders:', error);
            showAlert('Không thể tải đơn hàng', 'danger');
        }
    }
    
    // Render orders
    function renderOrders(orders) {
        const container = document.getElementById('orders-container');
        if (!container) return;
        
        if (orders.length === 0) {
            container.innerHTML = '<p class="text-center text-muted">Không có đơn hàng nào</p>';
            return;
        }
        
        container.innerHTML = '';
        
        orders.forEach(order => {
            const orderDiv = document.createElement('div');
            orderDiv.className = 'admin-card';
            
            // Create items list
            let itemsHtml = '';
            order.items.forEach(item => {
                itemsHtml += `
                    <div class="order-item">
                        <div class="d-flex justify-content-between">
                            <span>${item.product.name} x ${item.quantity}</span>
                            <span>${item.formatted_total}</span>
                        </div>
                    </div>
                `;
            });
            
            orderDiv.innerHTML = `
                <div class="row">
                    <div class="col-md-8">
                        <h6>Đơn hàng #${order.id}</h6>
                        <div class="row">
                            <div class="col-md-6">
                                <p class="mb-1"><strong>Khách hàng:</strong> ${order.customer_name}</p>
                                <p class="mb-1"><strong>SĐT:</strong> ${order.customer_phone}</p>
                                <p class="mb-1"><strong>Email:</strong> ${order.customer_email || 'Không có'}</p>
                            </div>
                            <div class="col-md-6">
                                <p class="mb-1"><strong>Địa chỉ:</strong> ${order.customer_address}</p>
                                <p class="mb-1"><strong>Thanh toán:</strong> ${order.payment_method_display}</p>
                                <p class="mb-1"><strong>Ngày tạo:</strong> ${new Date(order.created_at).toLocaleString('vi-VN')}</p>
                            </div>
                        </div>
                        
                        <div class="mt-3">
                            <h6>Chi tiết đơn hàng:</h6>
                            ${itemsHtml}
                        </div>
                        
                        ${order.notes ? `<div class="mt-2"><strong>Ghi chú:</strong> ${order.notes}</div>` : ''}
                    </div>
                    <div class="col-md-4">
                        <div class="text-end">
                            <h5 class="text-primary">${order.formatted_total}</h5>
                            <span class="status-badge status-${order.status}">${order.status_display}</span>
                            
                            <div class="mt-3">
                                <label class="form-label">Cập nhật trạng thái:</label>
                                <select class="form-select" onchange="updateOrderStatus(${order.id}, this.value)">
                                    <option value="pending" ${order.status === 'pending' ? 'selected' : ''}>Chờ xử lý</option>
                                    <option value="confirmed" ${order.status === 'confirmed' ? 'selected' : ''}>Đã xác nhận</option>
                                    <option value="preparing" ${order.status === 'preparing' ? 'selected' : ''}>Đang chuẩn bị</option>
                                    <option value="ready" ${order.status === 'ready' ? 'selected' : ''}>Sẵn sàng</option>
                                    <option value="delivered" ${order.status === 'delivered' ? 'selected' : ''}>Đã giao</option>
                                    <option value="cancelled" ${order.status === 'cancelled' ? 'selected' : ''}>Đã hủy</option>
                                </select>
                            </div>
                            
                            <div class="mt-2">
                                <small class="text-muted">
                                    Cập nhật lần cuối: ${new Date(order.updated_at).toLocaleString('vi-VN')}
                                </small>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            container.appendChild(orderDiv);
        });
    }
    
    // Filter orders
    function filterOrders() {
        const searchTerm = document.getElementById('search-orders').value.toLowerCase();
        const statusFilter = document.getElementById('filter-status').value;
        const paymentFilter = document.getElementById('filter-payment').value;
        
        let filteredOrders = allOrders.filter(order => {
            const matchesSearch = order.customer_name.toLowerCase().includes(searchTerm) || 
                                order.customer_phone.includes(searchTerm) ||
                                order.customer_email.toLowerCase().includes(searchTerm);
            const matchesStatus = !statusFilter || order.status === statusFilter;
            const matchesPayment = !paymentFilter || order.payment_method === paymentFilter;
            
            return matchesSearch && matchesStatus && matchesPayment;
        });
        
        renderOrders(filteredOrders);
    }
</script>
{% endblock %}
